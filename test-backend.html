<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend - UGT</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .loading { color: #00aaff; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            font-family: monospace;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico del Backend - UGT-CLM-UGR</h1>

    <div class="test-section">
        <h2>1. Test de Conectividad</h2>
        <button onclick="testHealth()">‚ñ∂ Probar Health Check</button>
        <div id="health-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Test de Variables de Entorno</h2>
        <button onclick="testEnvVars()">‚ñ∂ Verificar Variables</button>
        <div id="env-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de Admin Login</h2>
        <input type="text" id="admin-password" placeholder="Ingresa ADMIN_PASSWORD" style="padding: 10px; width: 300px;">
        <button onclick="testAdminLogin()">‚ñ∂ Probar Login</button>
        <div id="admin-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de Stripe</h2>
        <button onclick="testStripe()">‚ñ∂ Verificar Stripe Config</button>
        <div id="stripe-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Test de MongoDB</h2>
        <button onclick="testMongo()">‚ñ∂ Verificar Conexi√≥n MongoDB</button>
        <div id="mongo-result"></div>
    </div>

    <script>
        const BACKEND_URL = 'https://sindicato-mu.vercel.app';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'loading';
            element.innerHTML += `<div class="${color}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testHealth() {
            clearLog('health-result');
            log('health-result', '‚è≥ Probando health check...', 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();

                if (response.ok) {
                    log('health-result', '‚úÖ Backend est√° funcionando!', 'success');
                    log('health-result', `<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    log('health-result', '‚ùå Backend respondi√≥ pero con error', 'error');
                    log('health-result', `<pre>${JSON.stringify(data, null, 2)}</pre>`, 'error');
                }
            } catch (error) {
                log('health-result', '‚ùå ERROR: No se pudo conectar al backend', 'error');
                log('health-result', `Error: ${error.message}`, 'error');
                log('health-result', 'üí° Verifica que el backend est√© desplegado en Vercel', 'warning');
            }
        }

        async function testEnvVars() {
            clearLog('env-result');
            log('env-result', '‚è≥ Verificando variables de entorno...', 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();

                if (response.ok) {
                    log('env-result', '‚úÖ Variables configuradas:', 'success');
                    log('env-result', `  MONGODB_URI: ${data.mongoConnected ? '‚úÖ Configurado y conectado' : '‚ùå No conectado'}`, data.mongoConnected ? 'success' : 'error');
                    log('env-result', `  JWT_SECRET: ${data.jwtConfigured ? '‚úÖ Configurado' : '‚ùå No configurado'}`, data.jwtConfigured ? 'success' : 'error');
                    log('env-result', `  ADMIN_PASSWORD: ${data.adminPasswordConfigured ? '‚úÖ Configurado' : '‚ùå No configurado'}`, data.adminPasswordConfigured ? 'success' : 'error');

                    if (!data.mongoConnected) {
                        log('env-result', '‚ö†Ô∏è  MongoDB no est√° conectado. Verifica MONGODB_URI en Vercel', 'warning');
                    }
                    if (!data.jwtConfigured) {
                        log('env-result', '‚ö†Ô∏è  JWT_SECRET no configurado', 'warning');
                    }
                    if (!data.adminPasswordConfigured) {
                        log('env-result', '‚ö†Ô∏è  ADMIN_PASSWORD no configurado', 'warning');
                    }
                } else {
                    log('env-result', '‚ùå No se pudo verificar', 'error');
                }
            } catch (error) {
                log('env-result', '‚ùå Error al verificar', 'error');
                log('env-result', error.message, 'error');
            }
        }

        async function testAdminLogin() {
            clearLog('admin-result');
            const password = document.getElementById('admin-password').value;

            if (!password) {
                log('admin-result', '‚ö†Ô∏è  Ingresa la contrase√±a primero', 'warning');
                return;
            }

            log('admin-result', '‚è≥ Intentando login con contrase√±a...', 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    log('admin-result', '‚úÖ ¬°LOGIN EXITOSO!', 'success');
                    log('admin-result', `Token recibido (expira en ${data.expiresIn} segundos)`, 'success');
                    log('admin-result', `<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    log('admin-result', '‚ùå Login fall√≥', 'error');
                    log('admin-result', `Error: ${data.error || 'Contrase√±a incorrecta'}`, 'error');
                    log('admin-result', 'üí° La contrase√±a no coincide con ADMIN_PASSWORD en Vercel', 'warning');
                }
            } catch (error) {
                log('admin-result', '‚ùå Error al intentar login', 'error');
                log('admin-result', error.message, 'error');
            }
        }

        async function testStripe() {
            clearLog('stripe-result');
            log('stripe-result', '‚è≥ Verificando configuraci√≥n de Stripe...', 'loading');

            // Verificar que Stripe.js est√© cargado
            if (typeof Stripe === 'undefined') {
                log('stripe-result', '‚ùå Stripe.js no est√° cargado', 'error');
                return;
            }

            log('stripe-result', '‚úÖ Stripe.js cargado correctamente', 'success');

            // Verificar la clave p√∫blica
            try {
                const response = await fetch(`${BACKEND_URL}/api/config/stripe`);
                const data = await response.json();

                if (response.ok && data.publishableKey) {
                    log('stripe-result', '‚úÖ Clave p√∫blica de Stripe disponible', 'success');
                    log('stripe-result', `Clave: ${data.publishableKey.substring(0, 20)}...`, 'success');
                } else {
                    log('stripe-result', '‚ùå No se pudo obtener la clave de Stripe', 'error');
                    log('stripe-result', 'üí° Verifica STRIPE_PUBLISHABLE_KEY en Vercel', 'warning');
                }
            } catch (error) {
                log('stripe-result', '‚ùå Error al verificar Stripe', 'error');
                log('stripe-result', error.message, 'error');
            }
        }

        async function testMongo() {
            clearLog('mongo-result');
            log('mongo-result', '‚è≥ Verificando conexi√≥n a MongoDB...', 'loading');

            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();

                if (data.mongoConnected) {
                    log('mongo-result', '‚úÖ MongoDB conectado correctamente', 'success');
                    log('mongo-result', `Base de datos: ${data.database || 'N/A'}`, 'success');
                } else {
                    log('mongo-result', '‚ùå MongoDB NO est√° conectado', 'error');
                    log('mongo-result', 'üí° Posibles causas:', 'warning');
                    log('mongo-result', '  1. MONGODB_URI no configurado en Vercel', 'warning');
                    log('mongo-result', '  2. URI de MongoDB inv√°lido', 'warning');
                    log('mongo-result', '  3. IP de Vercel no est√° en la whitelist de MongoDB Atlas', 'warning');
                    log('mongo-result', '  4. Usuario/contrase√±a incorrectos en la URI', 'warning');
                }
            } catch (error) {
                log('mongo-result', '‚ùå Error al verificar MongoDB', 'error');
                log('mongo-result', error.message, 'error');
            }
        }

        // Auto-ejecutar health check al cargar
        window.addEventListener('load', () => {
            testHealth();
        });
    </script>

    <script src="https://js.stripe.com/v3/"></script>
</body>
</html>
